---
title: "R语言与日期时间管理"
date: 2019-06-01
categories:
  - R语言
  - 数据类型
tags:
  - R语言数据类型
keywords:
  - R语言
  - 数据类型
  - 日期时间管理
thumbnailImagePosition: left
thumbnailImage: https://i.postimg.cc/wxS2XdHW/4.png
---

**日期时间**作为日常生活中必不可少的一类信息，在数据分析中也有着非常重要的意义（尤其对于**时序分析**而言）。这篇文章将介绍**R语言**中的**日期时间**管理。

<!--more-->

<!-- toc -->

## 1、日期时间类对象

首先我们可以分别通过{{< hl-text primary >}}Sys.Date、Sys.time{{< /hl-text >}}函数，获取系统当前**日期**与当前**时间**。其中时间类的显示结果总是以某些特定的英文缩写作为后缀，代表的是时区（比如**GST**代表的是本地时间，**GMT**代表的是**格林威治时间**）。

在R语言中，日期类对象本质上是以数值的形式存储的（数值的含义是当前日期距离**1970-01-01**差多少天），拥有的类属性（class属性）为**Date**。

时间类对象则可以分为两类：其中拥有类属性**POSIXct**的对象,本质上是以数值的形式存储时间对象，数值代表当前时间距离**1970-01-01 00:00:00 GMT**差多少秒；而拥有类属性**POSIXlt**的对象，本质上是以列表的形式存储时间对象，列表中的元素**sec、min、hour、mday、mon、year、wday、yday、isdst、zone、gmtoff**分别代表秒、分、时、日、月、年（距离**1900**年差多少年）、星期、一年中的第几天、是否为夏令时、时区、当前时间距离格林威治时间差多少秒。两类对象都拥有类属性**POSIXt**，所以两者在R语言中是可以通用的。

注意因为R语言中重写了**POSIXlt**类对象的**print、str、as.list**等函数，所以我们必须通过特别的函数才能取出**POSIXlt**类对象的各个元素，比如筛选数据框元素的**[]**符号，或者{{< hl-text primary >}}[、unclass、unlist{{< /hl-text >}}等函数。

```R
> Sys.Date()
[1] "2019-06-01"
> Sys.time()
[1] "2019-06-01 09:26:27 CST"
> cat(Sys.Date(), Sys.time())
18048 1559352387
> x <- as.POSIXlt(Sys.time()); as.data.frame(unclass(x), row.names = "")
     sec min hour mday mon year wday yday isdst zone gmtoff
 27.0458  56   13   31   4  119    5  150     0  CST  28800
```

<br>

## 2、日期时间与字符串互相转换

有时候我们需要截取日期时间对象中的一部分数据（年份、月份、星期等）；或者当我们将字符串转换为日期时，需要指明日期中每一部分的数据在字符串的什么位置。此时我们就需要用到一些特定的符号，来表达日期时间中相应的部分，即**日期时间格式化表达符号**。以下表格我们以日期时间**2019-06-02 13:24:56**为例，总结了特定的日期时间格式化表达符号对应的内容，更详细的说明请参考`strptime`帮助文档。

| 表达符    | 运行结果                              | 解释说明                                              |
|:----------|:--------------------------------------|:------------------------------------------------------|
| %C        | 20                                    | 世纪                                                  |
| %y、%g    | 19                                    | 年份（简写）                                          |
| %Y、%G    | 2019                                  | 年份（全写）                                          |
| %m        | 06                                    | 月份                                                  |
| %u        | 7                                     | 星期                                                  |
| %w        | 0                                     | 星期（星期日为0）                                     |
| %U        | 22                                    | 一年中的第几个星期（从每年第一个周末开始算）          |
| %V        | 22                                    | 一年中的第几个星期（从每年第一个大于三天的星期开始算）|
| %W        | 21                                    | 一年中的第几个星期（从每年第一个周一开始算）          |
| %d        | 02                                    | 一月中的第几天（几号）                                |
| %e        |  2                                    | 一月中的第几天（以空格替换前面的0）                   |
| %j        | 153                                   | 一年中的第几天                                        |
| %H        | 13                                    | 小时（24小时制）                                      |
| %I        | 01                                    | 小时（12小时制）                                      |
| %M        | 24                                    | 分钟                                                  |
| %S        | 56                                    | 秒                                                    |
| %F        | 2019-06-02                            | 年月日（相当于%Y-%m-%d）                              |
| %D        | 06/02/19                              | 月日年（相当于%m/%d/%Y）                              |
| %R        | 13:24                                 | 时分（相当于%H:%M）                                   |
| %T        | 13:24:56                              | 时分秒（相当于%H:%M:%S）                              |
| %A        | 星期日                                | 以本地格式显示星期                                    |
| %a        | 日                                    | 以本地格式显示星期（简写）                            |
| %B        | 六月                                  | 以本地格式显示月份                                    | 
| %b、%h    | 6月                                   | 以本地格式显示月份 （简写）                           |
| %p        | 下午                                  | 以本地格式显示上午或是下午                            |
| %x        | 2019年06月02日                        | 以本地格式显示日期                                    |
| %X        | 13时24分56秒                          | 以本地格式显示时间                                    |
| %r        | 下午 01时24分56秒                     | 以本地格式显示时间（12小时制）                        |
| %c        | 2019年06月02日 星期日 13时24分56秒    | 以本地格式显示年月日、星期、时分秒                    |
| %z        | +0800                                 | 时间距离当前时区的差值                                |
| %Z        | CST                                   | 时区                                                  |

掌握了R语言中的日期时间格式化表达符号，我们就可以分别通过{{< hl-text primary >}}strptime、strftime{{< /hl-text >}}函数，在日期时间类对象与字符串对象之间互相转换。

此外R语言中还定义了一些便捷函数，比如我们可以分别通过{{< hl-text primary >}}weekdays、months、quarters{{< /hl-text >}}函数，取出日期中的**星期**、**月份**、**季度**。

```R
> x <- strptime("2019-06-02 13:24:56", format = "%Y-%m-%d %H:%M:%S"); x
[1] "2019-06-02 13:24:56 CST"
> strftime(x, format = "%Y/%m/%d %H:%M:%S")
[1] "2019/06/02 13:24:56"
> c(weekdays(x), months(x), months(x, abbreviate = TRUE), quarters(x))
[1] "星期日" "六月"   "6月"    "Q2"  
```

<br>

## 3、日期时间的数学运算

我们可以通过{{< hl-text primary >}}difftime(time1, time2, tz, units){{< /hl-text >}}的形式，计算两个日期时间类对象之间的**时间差**。这个时间差（**units**）可以是**secs、mins、hours、days、weeks**中的一个（默认会自动选择合适的时间差单位）。

计算时间差后会生成一个类属性为**difftime**的对象，我们还可以通过{{< hl-text primary >}}units{{< /hl-text >}}函数，调整时间差的单位。

```R
> x <- as.Date("2019-06-01"); y <- as.Date("2019-05-28")
> z <- difftime(x, y); z
Time difference of 4 days
> units(z) <- "weeks"; z
Time difference of 0.5714286 weeks
```

上文已经介绍到，R语言中的日期时间类对象都是可以用数值表示的。所以日期时间类对象也可以直接与数值进行加减运算，其中日期类对象加减数值代表特定日期向后、向前推算多少天；而时间类对象加减数值代表特定日期向后、向前推算多少秒。当然我们也可以先将数值转化为时间差对象，再与日期时间进行加减。

当我们将数值转换为日期时间类对象时，总是需要事先指定一个日期时间类参数**origin**。其实就相当于从**origin**开始向后推算多少天/秒。

```R
> x <- as.Date("2019-06-01")
> x - 7
[1] "2019-05-25"
> x - as.difftime(1, units = "weeks")
[1] "2019-05-25"
```

最后，R语言中还可以对日期时间类对象进行精度取舍，求均值等操作。注意精度取舍之后生成的数据与原日期时间对象的数据结构时一致的，比如对日期**2019-06-01**按月份取舍之后，依然是**2019-06-01**，而不是**2019-06**。

```R
> x <- seq(as.POSIXct("2019-06-01 09:30:00"), as.POSIXct("2019-06-01 12:00:00"), "hour"); x
[1] "2019-06-01 09:30:00 CST" "2019-06-01 10:30:00 CST" "2019-06-01 11:30:00 CST"
> round(x, "hours")
[1] "2019-06-01 10:00:00 CST" "2019-06-01 11:00:00 CST" "2019-06-01 12:00:00 CST"
> mean(x)
[1] "2019-06-01 10:30:00 CST"
```

<br>

{{< note "思考思考" "#e6e6ff" >}}
- 将日期类对象转换为时间类对象会有什么结果（`as.POSIXct(Sys.Date())`）？
- 如何取出时间类对象（**POSIXlt**）的毫秒？
- 如何计算任意两个日期之间相差多少个月份？

{{< /note >}}

<br>
